(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.img = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
"use strict";

module.exports = img;

var _utils = require("./utils");

var load_image = _utils.load_image;
var create_image_data = _utils.create_image_data;
var clone_image_data = _utils.clone_image_data;
var multiply_matrix = _utils.multiply_matrix;

function img(src) {
  return unit(src);
}

var proto = {};

function unit(src) {
  var promise = src instanceof Promise ? src : load_image(src);

  promise["catch"](function (e) {
    console.log("load promise failed", e);
  });

  var monad = Object.create(proto);

  monad.bind = function (func) {
    for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      args[_key - 1] = arguments[_key];
    }

    return unit(promise.then(function (img) {
      var t1 = performance.now();
      var res = func.apply(undefined, [img].concat(args));
      var t2 = performance.now();
      console.log("timing is ", t2 - t1, func.toString().match(/^function\s(\w+)/)[1]);

      return res;
    }));
  };

  return monad;
}

function lift(name, func) {
  proto[name] = function () {
    var _ref;

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    return (_ref = this).bind.apply(_ref, [func].concat(args));
  };
}

lift("outputTo", function outputTo(data, el) {
  var c = document.createElement("canvas");
  c.width = data.width;c.height = data.height;

  var ctx = c.getContext("2d");
  ctx.putImageData(data, 0, 0);

  //var node = new Image();
  //node.src = c.toDataURL("image/png");

  el.innerHTML = "";
  el.appendChild(c);
});

lift("identity", function (data) {
  var new_data = create_image_data(data.width, data.height);
  var cur_pos, new_pos;

  for (var x = 0; x < data.width; ++x) {
    for (var y = 0; y < data.height; ++y) {
      cur_pos = (y * data.width + x) * 4;
      new_pos = (y * data.width + x) * 4;

      new_data.data[new_pos] = data.data[cur_pos];
      new_data.data[new_pos + 1] = data.data[cur_pos + 1];
      new_data.data[new_pos + 2] = data.data[cur_pos + 2];
      new_data.data[new_pos + 3] = data.data[cur_pos + 3];
    }
  }

  return new_data;
});

lift("identity2", function (data) {
  var new_data = clone_image_data(data);

  return multiply_matrix(new_data, [[1, 0, 0, 0], [0, 1, 0, 0], [0, 0, 1, 0], [0, 0, 0, 1]]);
});

lift("flipY", function (data) {
  var new_data = create_image_data(data.width, data.height);
  var cur_pos, new_pos;

  for (var x = 0; x < data.width; ++x) {
    for (var y = 0; y < data.height; ++y) {
      cur_pos = (y * data.width + x) * 4;
      new_pos = ((data.height - y - 1) * data.width + x) * 4;

      new_data.data[new_pos] = data.data[cur_pos];
      new_data.data[new_pos + 1] = data.data[cur_pos + 1];
      new_data.data[new_pos + 2] = data.data[cur_pos + 2];
      new_data.data[new_pos + 3] = data.data[cur_pos + 3];
    }
  }

  return new_data;
});

lift("flipX", function (data) {
  var new_data = create_image_data(data.width, data.height);
  var cur_pos, new_pos;

  for (var x = 0; x < data.width; ++x) {
    for (var y = 0; y < data.height; ++y) {
      cur_pos = (y * data.width + x) * 4;
      new_pos = (y * data.width + (data.width - x - 1)) * 4;

      new_data.data[new_pos] = data.data[cur_pos];
      new_data.data[new_pos + 1] = data.data[cur_pos + 1];
      new_data.data[new_pos + 2] = data.data[cur_pos + 2];
      new_data.data[new_pos + 3] = data.data[cur_pos + 3];
    }
  }

  return new_data;
});

lift("inverse", function (data) {
  var new_data = create_image_data(data.width, data.height);
  var cur_pos, new_pos;

  for (var x = 0; x < data.width; ++x) {
    for (var y = 0; y < data.height; ++y) {
      cur_pos = (y * data.width + x) * 4;
      new_pos = (y * data.width + x) * 4;

      new_data.data[new_pos] = 255 - data.data[cur_pos];
      new_data.data[new_pos + 1] = 255 - data.data[cur_pos + 1];
      new_data.data[new_pos + 2] = 255 - data.data[cur_pos + 2];
      new_data.data[new_pos + 3] = data.data[cur_pos + 3];
    }
  }

  return new_data;
});

lift("grayscale", function grayscale(data) {
  var new_data = create_image_data(data.width, data.height);
  var cur_pos, new_pos;
  var luminosity;

  var arr = data.data;
  var new_arr = new_data.data;

  for (var x = 0; x < data.width; ++x) {
    for (var y = 0; y < data.height; ++y) {
      cur_pos = (y * data.width + x) * 4;
      new_pos = (y * data.width + x) * 4;
      luminosity = 0.21 * arr[cur_pos] + 0.72 * arr[cur_pos + 1] + 0.07 * arr[cur_pos + 2];

      new_arr[new_pos] = luminosity;
      new_arr[new_pos + 1] = luminosity;
      new_arr[new_pos + 2] = luminosity;
      new_arr[new_pos + 3] = arr[cur_pos + 3];
    }
  }

  return new_data;
});

lift("grayscale2", function grayscale2(data) {
  var new_data = clone_image_data(data);

  return multiply_matrix(new_data, [[0.21, 0.72, 0.07, 0], [0.21, 0.72, 0.07, 0], [0.21, 0.72, 0.07, 0], [0, 0, 0, 1]]);
});

},{"./utils":2}],2:[function(require,module,exports){
"use strict";

exports.load_image = load_image;
exports.create_image_data = create_image_data;
exports.clone_image_data = clone_image_data;

/* will modify data inplace */
exports.multiply_matrix = multiply_matrix;
Object.defineProperty(exports, "__esModule", {
  value: true
});

function load_image(src) {
  if (src instanceof Image) {
    return new Promise(function (accept) {
      accept(src);
    });
  }

  return new Promise(function (accept, reject) {
    var img = new Image();
    img.onload = function () {
      var c = document.createElement("canvas");
      c.width = img.width;c.height = img.height;

      var ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0);

      var image_data = ctx.getImageData(0, 0, c.width, c.height);

      accept(image_data);
      img = null;
    };

    img.onerror = function (err) {
      reject(err);
      img = null;
    };

    img.src = src;
  });
}

function create_image_data(width, height) {
  var c = document.createElement("canvas");

  return c.getContext("2d").createImageData(width, height);
}

function clone_image_data(data) {
  var c = document.createElement("canvas");
  var ctx = c.getContext("2d");

  var width = data.width;
  var height = data.height;

  c.width = width;c.height = height;

  ctx.putImageData(data, 0, 0);
  return ctx.getImageData(0, 0, width, height);
}

function multiply_matrix(data, matrix) {
  if (matrix.length !== 4 || matrix.filter(function (el) {
    return el.length !== 4;
  }).length > 0) throw new Error("filter matrix can be only 4 by 4");

  var max = data.width * data.height;

  var buf = new ArrayBuffer(data.data.length);
  var buf8 = new Uint8ClampedArray(buf);
  var buf32 = new Uint32Array(buf);

  for (var pos = 0; pos < max; ++pos) {
    var real_pos = pos * 4;

    //buf32[pos] = (
    //((data.data[real_pos] * matrix[3][0] + data.data[real_pos + 1] * matrix[3][1] + data.data[real_pos + 2] * matrix[3][2] + data.data[real_pos + 3] * matrix[3][3]) << 24) |
    //((data.data[real_pos] * matrix[2][0] + data.data[real_pos + 1] * matrix[2][1] + data.data[real_pos + 2] * matrix[2][2] + data.data[real_pos + 3] * matrix[2][3]) << 16) |
    //((data.data[real_pos] * matrix[1][0] + data.data[real_pos + 1] * matrix[1][1] + data.data[real_pos + 2] * matrix[1][2] + data.data[real_pos + 3] * matrix[1][3]) << 8) |
    //((data.data[real_pos] * matrix[0][0] + data.data[real_pos + 1] * matrix[0][1] + data.data[real_pos + 2] * matrix[0][2] + data.data[real_pos + 3] * matrix[0][3]))
    //);
    for (var comp = 0; comp < 4; ++comp) {
      buf8[real_pos + comp] = data.data[real_pos] * matrix[comp][0] + data.data[real_pos + 1] * matrix[comp][1] + data.data[real_pos + 2] * matrix[comp][2] + data.data[real_pos + 3] * matrix[comp][3];
    }
  }

  data.data.set(buf8);

  return data;
}

},{}]},{},[1])(1)
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCIvVXNlcnMvZHBldHJvdi9jb2RlL2pzL2ltZy5qcy9saWIvaW1nLmpzIiwiL1VzZXJzL2RwZXRyb3YvY29kZS9qcy9pbWcuanMvbGliL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7aUJDSXdCLEdBQUc7O3FCQUZvRCxTQUFTOztJQUFoRixVQUFVLFVBQVYsVUFBVTtJQUFFLGlCQUFpQixVQUFqQixpQkFBaUI7SUFBRSxnQkFBZ0IsVUFBaEIsZ0JBQWdCO0lBQUUsZUFBZSxVQUFmLGVBQWU7O0FBRXpELFNBQVMsR0FBRyxDQUFDLEdBQUcsRUFBRTtBQUMvQixTQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUNsQjs7QUFFRCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7O0FBRWYsU0FBUyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBQ2pCLE1BQUksT0FBTyxHQUFHLEdBQUcsWUFBWSxPQUFPLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7QUFFN0QsU0FBTyxTQUFNLENBQUMsVUFBUyxDQUFDLEVBQUU7QUFDeEIsV0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQztHQUN2QyxDQUFDLENBQUM7O0FBRUgsTUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFakMsT0FBSyxDQUFDLElBQUksR0FBRyxVQUFTLElBQUksRUFBVztzQ0FBTixJQUFJO0FBQUosVUFBSTs7O0FBQ2pDLFdBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBUyxHQUFHLEVBQUU7QUFDckMsVUFBSSxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzNCLFVBQUksR0FBRyxHQUFHLElBQUksbUJBQUMsR0FB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LElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDNUMsTUFBSSxJQUFJLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN0QyxNQUFJLEtBQUssR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7QUFFakMsT0FBSyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRTtBQUNsQyxRQUFJLFFBQVEsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDOzs7Ozs7OztBQVF2QixTQUFLLElBQUksSUFBSSxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFO0FBQ25DLFVBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxBQUMxQyxDQUFDO0tBQ0g7R0FDRjs7QUFFRCxNQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFcEIsU0FBTyxJQUFJLENBQUM7Q0FDYiIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJcInVzZSBzdHJpY3RcIlxuXG5pbXBvcnQge2xvYWRfaW1hZ2UsIGNyZWF0ZV9pbWFnZV9kYXRhLCBjbG9uZV9pbWFnZV9kYXRhLCBtdWx0aXBseV9tYXRyaXh9IGZyb20gJy4vdXRpbHMnXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGltZyhzcmMpIHtcbiAgcmV0dXJuIHVuaXQoc3JjKTtcbn1cblxudmFyIHByb3RvID0ge307XG5cbmZ1bmN0aW9uIHVuaXQoc3JjKSB7XG4gIHZhciBwcm9taXNlID0gc3JjIGluc3RhbmNlb2YgUHJvbWlzZSA/IHNyYyA6IGxvYWRfaW1hZ2Uoc3JjKTtcblxuICBwcm9taXNlLmNhdGNoKGZ1bmN0aW9uKGUpIHtcbiAgICBjb25zb2xlLmxvZygnbG9hZCBwcm9taXNlIGZhaWxlZCcsIGUpO1xuICB9KTtcblxuICB2YXIgbW9uYWQgPSBPYmplY3QuY3JlYXRlKHByb3RvKTtcblxuICBtb25hZC5iaW5kID0gZnVuY3Rpb24oZnVuYywgLi4uYXJncykge1xuICAgIHJldHVybiB1bml0KHByb21pc2UudGhlbihmdW5jdGlvbihpbWcpIHtcbiAgICAgIHZhciB0MSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgdmFyIHJlcyA9IGZ1bmMoaW1nLCAuLi5hcmdzKTtcbiAgICAgIHZhciB0MiA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgY29uc29sZS5sb2coJ3RpbWluZyBpcyAnLCB0Mi10MSwgZnVuYy50b1N0cmluZygpLm1hdGNoKC9eZnVuY3Rpb25cXHMoXFx3KykvKVsxXSk7XG5cbiAgICAgIHJldHVybiByZXM7XG4gICAgfSkpO1xuICB9O1xuXG4gIHJldHVybiBtb25hZDtcbn1cblxuZnVuY3Rpb24gbGlmdChuYW1lLCBmdW5jKSB7XG4gIHByb3RvW25hbWVdID0gZnVuY3Rpb24oLi4uYXJncykge1xuICAgIHJldHVybiB0aGlzLmJpbmQoZnVuYywgLi4uYXJncyk7XG4gIH07XG59XG5cbmxpZnQoJ291dHB1dFRvJywgZnVuY3Rpb24gb3V0cHV0VG8oZGF0YSwgZWwpIHtcbiAgdmFyIGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgYy53aWR0aCA9IGRhdGEud2lkdGg7IGMuaGVpZ2h0ID0gZGF0YS5oZWlnaHQ7XG5cbiAgdmFyIGN0eCA9IGMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgY3R4LnB1dEltYWdlRGF0YShkYXRhLCAwLCAwKTtcblxuICAvL3ZhciBub2RlID0gbmV3IEltYWdlKCk7XG4gIC8vbm9kZS5zcmMgPSBjLnRvRGF0YVVSTChcImltYWdlL3BuZ1wiKTtcblxuICBlbC5pbm5lckhUTUwgPSAnJztcbiAgZWwuYXBwZW5kQ2hpbGQoYyk7XG59KTtcblxubGlmdCgnaWRlbnRpdHknLCBmdW5jdGlvbihkYXRhKSB7XG4gIHZhciBuZXdfZGF0YSA9IGNyZWF0ZV9pbWFnZV9kYXRhKGRhdGEud2lkdGgsIGRhdGEuaGVpZ2h0KTtcbiAgdmFyIGN1cl9wb3MsIG5ld19wb3M7XG5cbiAgZm9yICh2YXIgeCA9IDA7IHggPCBkYXRhLndpZHRoOyArK3gpIHtcbiAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGRhdGEuaGVpZ2h0OyArK3kpIHtcbiAgICAgIGN1cl9wb3MgPSAoeSAqIGRhdGEud2lkdGggKyB4KSAqIDQ7XG4gICAgICBuZXdfcG9zID0gKHkgKiBkYXRhLndpZHRoICsgeCkgKiA0O1xuXG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3NdID0gZGF0YS5kYXRhW2N1cl9wb3NdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgMV0gPSBkYXRhLmRhdGFbY3VyX3BvcyArIDFdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgMl0gPSBkYXRhLmRhdGFbY3VyX3BvcyArIDJdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgM10gPSBkYXRhLmRhdGFbY3VyX3BvcyArIDNdO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBuZXdfZGF0YTtcbn0pO1xuXG5saWZ0KCdpZGVudGl0eTInLCBmdW5jdGlvbihkYXRhKSB7XG4gIHZhciBuZXdfZGF0YSA9IGNsb25lX2ltYWdlX2RhdGEoZGF0YSk7XG5cbiAgcmV0dXJuIG11bHRpcGx5X21hdHJpeChuZXdfZGF0YSwgWyBbMSwgMCwgMCwgMF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWzAsIDEsIDAsIDBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFswLCAwLCAxLCAwXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMCwgMCwgMCwgMV0gXSk7XG59KTtcblxubGlmdCgnZmxpcFknLCBmdW5jdGlvbihkYXRhKSB7XG4gIHZhciBuZXdfZGF0YSA9IGNyZWF0ZV9pbWFnZV9kYXRhKGRhdGEud2lkdGgsIGRhdGEuaGVpZ2h0KTtcbiAgdmFyIGN1cl9wb3MsIG5ld19wb3M7XG5cbiAgZm9yICh2YXIgeCA9IDA7IHggPCBkYXRhLndpZHRoOyArK3gpIHtcbiAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGRhdGEuaGVpZ2h0OyArK3kpIHtcbiAgICAgIGN1cl9wb3MgPSAoeSAqIGRhdGEud2lkdGggKyB4KSAqIDQ7XG4gICAgICBuZXdfcG9zID0gKChkYXRhLmhlaWdodCAtIHkgLSAxKSAqIGRhdGEud2lkdGggKyB4KSAqIDQ7XG5cbiAgICAgIG5ld19kYXRhLmRhdGFbbmV3X3Bvc10gPSBkYXRhLmRhdGFbY3VyX3Bvc107XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAxXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgMV07XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAyXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgMl07XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAzXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgM107XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ld19kYXRhO1xufSk7XG5cbmxpZnQoJ2ZsaXBYJywgZnVuY3Rpb24oZGF0YSkge1xuICB2YXIgbmV3X2RhdGEgPSBjcmVhdGVfaW1hZ2VfZGF0YShkYXRhLndpZHRoLCBkYXRhLmhlaWdodCk7XG4gIHZhciBjdXJfcG9zLCBuZXdfcG9zO1xuXG4gIGZvciAodmFyIHggPSAwOyB4IDwgZGF0YS53aWR0aDsgKyt4KSB7XG4gICAgZm9yICh2YXIgeSA9IDA7IHkgPCBkYXRhLmhlaWdodDsgKyt5KSB7XG4gICAgICBjdXJfcG9zID0gKHkgKiBkYXRhLndpZHRoICsgeCkgKiA0O1xuICAgICAgbmV3X3BvcyA9ICh5ICogZGF0YS53aWR0aCArIChkYXRhLndpZHRoIC0geCAtIDEpKSAqIDQ7XG5cbiAgICAgIG5ld19kYXRhLmRhdGFbbmV3X3Bvc10gPSBkYXRhLmRhdGFbY3VyX3Bvc107XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAxXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgMV07XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAyXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgMl07XG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3MgKyAzXSA9IGRhdGEuZGF0YVtjdXJfcG9zICsgM107XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ld19kYXRhO1xufSk7XG5cbmxpZnQoJ2ludmVyc2UnLCBmdW5jdGlvbihkYXRhKSB7XG4gIHZhciBuZXdfZGF0YSA9IGNyZWF0ZV9pbWFnZV9kYXRhKGRhdGEud2lkdGgsIGRhdGEuaGVpZ2h0KTtcbiAgdmFyIGN1cl9wb3MsIG5ld19wb3M7XG5cbiAgZm9yICh2YXIgeCA9IDA7IHggPCBkYXRhLndpZHRoOyArK3gpIHtcbiAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGRhdGEuaGVpZ2h0OyArK3kpIHtcbiAgICAgIGN1cl9wb3MgPSAoeSAqIGRhdGEud2lkdGggKyB4KSAqIDQ7XG4gICAgICBuZXdfcG9zID0gKHkgKiBkYXRhLndpZHRoICsgeCkgKiA0O1xuXG4gICAgICBuZXdfZGF0YS5kYXRhW25ld19wb3NdID0gMjU1IC0gZGF0YS5kYXRhW2N1cl9wb3NdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgMV0gPSAyNTUgLSBkYXRhLmRhdGFbY3VyX3BvcyArIDFdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgMl0gPSAyNTUgLSBkYXRhLmRhdGFbY3VyX3BvcyArIDJdO1xuICAgICAgbmV3X2RhdGEuZGF0YVtuZXdfcG9zICsgM10gPSBkYXRhLmRhdGFbY3VyX3BvcyArIDNdO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBuZXdfZGF0YTtcbn0pO1xuXG5saWZ0KCdncmF5c2NhbGUnLCBmdW5jdGlvbiBncmF5c2NhbGUoZGF0YSkge1xuICB2YXIgbmV3X2RhdGEgPSBjcmVhdGVfaW1hZ2VfZGF0YShkYXRhLndpZHRoLCBkYXRhLmhlaWdodCk7XG4gIHZhciBjdXJfcG9zLCBuZXdfcG9zO1xuICB2YXIgbHVtaW5vc2l0eTtcblxuICB2YXIgYXJyID0gZGF0YS5kYXRhO1xuICB2YXIgbmV3X2FyciA9IG5ld19kYXRhLmRhdGE7XG5cbiAgZm9yICh2YXIgeCA9IDA7IHggPCBkYXRhLndpZHRoOyArK3gpIHtcbiAgICBmb3IgKHZhciB5ID0gMDsgeSA8IGRhdGEuaGVpZ2h0OyArK3kpIHtcbiAgICAgIGN1cl9wb3MgPSAoeSAqIGRhdGEud2lkdGggKyB4KSAqIDQ7XG4gICAgICBuZXdfcG9zID0gKHkgKiBkYXRhLndpZHRoICsgeCkgKiA0O1xuICAgICAgbHVtaW5vc2l0eSA9ICAwLjIxICogYXJyW2N1cl9wb3NdICtcbiAgICAgICAgICAgICAgICAgICAgMC43MiAqIGFycltjdXJfcG9zICsgMV0gK1xuICAgICAgICAgICAgICAgICAgICAwLjA3ICogYXJyW2N1cl9wb3MgKyAyXTtcblxuICAgICAgbmV3X2FycltuZXdfcG9zXSA9IGx1bWlub3NpdHk7XG4gICAgICBuZXdfYXJyW25ld19wb3MgKyAxXSA9IGx1bWlub3NpdHk7XG4gICAgICBuZXdfYXJyW25ld19wb3MgKyAyXSA9IGx1bWlub3NpdHk7XG4gICAgICBuZXdfYXJyW25ld19wb3MgKyAzXSA9IGFycltjdXJfcG9zICsgM107XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ld19kYXRhO1xufSk7XG5cbmxpZnQoJ2dyYXlzY2FsZTInLCBmdW5jdGlvbiBncmF5c2NhbGUyKGRhdGEpIHtcbiAgdmFyIG5ld19kYXRhID0gY2xvbmVfaW1hZ2VfZGF0YShkYXRhKTtcblxuICByZXR1cm4gbXVsdGlwbHlfbWF0cml4KG5ld19kYXRhLCBbIFswLjIxLCAwLjcyLCAwLjA3LCAwXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbMC4yMSwgMC43MiwgMC4wNywgMF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWzAuMjEsIDAuNzIsIDAuMDcsIDBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFswICAgLCAwLCAgICAwLCAgICAxXSBdKTtcbn0pO1xuIiwiZXhwb3J0IGZ1bmN0aW9uIGxvYWRfaW1hZ2Uoc3JjKSB7XG4gIGlmIChzcmMgaW5zdGFuY2VvZiBJbWFnZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihhY2NlcHQpIHtcbiAgICAgIGFjY2VwdChzcmMpO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKGFjY2VwdCwgcmVqZWN0KSB7XG4gICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICBjLndpZHRoID0gaW1nLndpZHRoOyBjLmhlaWdodCA9IGltZy5oZWlnaHQ7XG5cbiAgICAgIHZhciBjdHggPSBjLmdldENvbnRleHQoJzJkJyk7XG4gICAgICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7XG5cbiAgICAgIHZhciBpbWFnZV9kYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCBjLndpZHRoLCBjLmhlaWdodCk7XG5cbiAgICAgIGFjY2VwdChpbWFnZV9kYXRhKTtcbiAgICAgIGltZyA9IG51bGw7XG4gICAgfTtcblxuICAgIGltZy5vbmVycm9yID0gZnVuY3Rpb24oZXJyKSB7XG4gICAgICByZWplY3QoZXJyKTtcbiAgICAgIGltZyA9IG51bGw7XG4gICAgfTtcblxuICAgIGltZy5zcmMgPSBzcmM7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlX2ltYWdlX2RhdGEod2lkdGgsIGhlaWdodCkge1xuICB2YXIgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuXG4gIHJldHVybiBjLmdldENvbnRleHQoXCIyZFwiKS5jcmVhdGVJbWFnZURhdGEod2lkdGgsIGhlaWdodCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbG9uZV9pbWFnZV9kYXRhKGRhdGEpIHtcbiAgbGV0IGMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgbGV0IGN0eCA9IGMuZ2V0Q29udGV4dChcIjJkXCIpO1xuXG4gIGxldCB7d2lkdGgsIGhlaWdodH0gPSBkYXRhO1xuICBjLndpZHRoID0gd2lkdGg7IGMuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gIGN0eC5wdXRJbWFnZURhdGEoZGF0YSwgMCwgMCk7XG4gIHJldHVybiBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xufVxuXG4vKiB3aWxsIG1vZGlmeSBkYXRhIGlucGxhY2UgKi9cbmV4cG9ydCBmdW5jdGlvbiBtdWx0aXBseV9tYXRyaXgoZGF0YSwgbWF0cml4KSB7XG4gIGlmIChtYXRyaXgubGVuZ3RoICE9PSA0IHx8IG1hdHJpeC5maWx0ZXIoIChlbCkgPT4gZWwubGVuZ3RoICE9PSA0ICkubGVuZ3RoID4gMClcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJmaWx0ZXIgbWF0cml4IGNhbiBiZSBvbmx5IDQgYnkgNFwiKTtcblxuICBsZXQgbWF4ID0gZGF0YS53aWR0aCAqIGRhdGEuaGVpZ2h0O1xuXG4gIHZhciBidWYgPSBuZXcgQXJyYXlCdWZmZXIoZGF0YS5kYXRhLmxlbmd0aCk7XG4gIHZhciBidWY4ID0gbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KGJ1Zik7XG4gIHZhciBidWYzMiA9IG5ldyBVaW50MzJBcnJheShidWYpO1xuXG4gIGZvciAobGV0IHBvcyA9IDA7IHBvcyA8IG1heDsgKytwb3MpIHtcbiAgICBsZXQgcmVhbF9wb3MgPSBwb3MgKiA0O1xuXG4gICAgLy9idWYzMltwb3NdID0gKFxuICAgICAgLy8oKGRhdGEuZGF0YVtyZWFsX3Bvc10gKiBtYXRyaXhbM11bMF0gKyBkYXRhLmRhdGFbcmVhbF9wb3MgKyAxXSAqIG1hdHJpeFszXVsxXSArIGRhdGEuZGF0YVtyZWFsX3BvcyArIDJdICogbWF0cml4WzNdWzJdICsgZGF0YS5kYXRhW3JlYWxfcG9zICsgM10gKiBtYXRyaXhbM11bM10pIDw8IDI0KSB8XG4gICAgICAvLygoZGF0YS5kYXRhW3JlYWxfcG9zXSAqIG1hdHJpeFsyXVswXSArIGRhdGEuZGF0YVtyZWFsX3BvcyArIDFdICogbWF0cml4WzJdWzFdICsgZGF0YS5kYXRhW3JlYWxfcG9zICsgMl0gKiBtYXRyaXhbMl1bMl0gKyBkYXRhLmRhdGFbcmVhbF9wb3MgKyAzXSAqIG1hdHJpeFsyXVszXSkgPDwgMTYpIHxcbiAgICAgIC8vKChkYXRhLmRhdGFbcmVhbF9wb3NdICogbWF0cml4WzFdWzBdICsgZGF0YS5kYXRhW3JlYWxfcG9zICsgMV0gKiBtYXRyaXhbMV1bMV0gKyBkYXRhLmRhdGFbcmVhbF9wb3MgKyAyXSAqIG1hdHJpeFsxXVsyXSArIGRhdGEuZGF0YVtyZWFsX3BvcyArIDNdICogbWF0cml4WzFdWzNdKSA8PCA4KSB8XG4gICAgICAvLygoZGF0YS5kYXRhW3JlYWxfcG9zXSAqIG1hdHJpeFswXVswXSArIGRhdGEuZGF0YVtyZWFsX3BvcyArIDFdICogbWF0cml4WzBdWzFdICsgZGF0YS5kYXRhW3JlYWxfcG9zICsgMl0gKiBtYXRyaXhbMF1bMl0gKyBkYXRhLmRhdGFbcmVhbF9wb3MgKyAzXSAqIG1hdHJpeFswXVszXSkpXG4gICAgLy8pO1xuICAgIGZvciAobGV0IGNvbXAgPSAwOyBjb21wIDwgNDsgKytjb21wKSB7XG4gICAgICBidWY4W3JlYWxfcG9zICsgY29tcF0gPSAoXG4gICAgICAgIGRhdGEuZGF0YVtyZWFsX3Bvc10gKiBtYXRyaXhbY29tcF1bMF0gK1xuICAgICAgICBkYXRhLmRhdGFbcmVhbF9wb3MgKyAxXSAqIG1hdHJpeFtjb21wXVsxXSArXG4gICAgICAgIGRhdGEuZGF0YVtyZWFsX3BvcyArIDJdICogbWF0cml4W2NvbXBdWzJdICtcbiAgICAgICAgZGF0YS5kYXRhW3JlYWxfcG9zICsgM10gKiBtYXRyaXhbY29tcF1bM11cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgZGF0YS5kYXRhLnNldChidWY4KTtcblxuICByZXR1cm4gZGF0YTtcbn1cbiJdfQ==
